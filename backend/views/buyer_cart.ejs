<%- include('partials/common_header'); %> 

  <body class="h-full bg-white dark:bg-slate-900">
    <div class="flex flex-no-wrap">
      <!-- Sidebar starts -->
      <%- include('partials/buyer_left_bar'); %>
      <!-- Sidebar ends -->

      <div class="container mx-auto overflow-auto">
        
        <%- include('partials/buyer_top_bar'); %>

        <%- include('partials/common_body'); %>
          <!-- Place your content here -->
            <!-- Place your content here -->

            <!-- cart -->
            <section>
              <div class="w-full bg-opacity-90 top-0" id="chec-div">
                <div
                  class="right-0 transform translate-x-0 transition ease-in-out duration-700"
                  id="checkout"
                >
                  <div
                    class="flex lg:flex-row flex-col justify-center"
                    id="cart"
                  >
                    <div
                      class="lg:w-1/2 md:w-8/12 w-full lg:px-8 lg:py-14 md:px-6 px-4 md:py-8 py-4 bg-white dark:bg-gray-800 overflow-y-hidden overflow-x-hidden lg:h-screen h-auto"
                      id="scroll"
                    >
                      <div
                        class="flex items-center text-gray-500 hover:text-gray-600 dark:text-white cursor-pointer"
                        onclick="checkoutHandler(false)"
                      >
                        <img
                          class="dark:hidden"
                          src="https://tuk-cdn.s3.amazonaws.com/can-uploader/shopping-cart-1-svg1.svg"
                          alt="previous"
                        />
                        <img
                          class="dark:block hidden"
                          src="https://tuk-cdn.s3.amazonaws.com/can-uploader/shopping-cart-1-svg1dark.svg"
                          alt="previous"
                        />
                        <p
                          class="text-sm pl-2 leading-none dark:hover:text-gray-200"
                        >
                          Back
                        </p>
                      </div>
                      <p
                        class="lg:text-4xl text-3xl font-black leading-10 text-gray-800 dark:text-white pt-3"
                      >
                        Cart
                      </p>

                      <% 
                      var total = 0;
                      for(var x in cart){ 
                        total += Number(cart[x].unit_price) * Number(cart[x].quantity);
                        %>
                      <div
                        class="md:flex items-strech py-8 md:py-10 lg:py-8 border-t border-gray-50"
                      >
                        <!-- <div class="md:w-4/12 2xl:w-1/4 w-full">
                          <img
                            src="https://i.ibb.co/SX762kX/Rectangle-36-1.png"
                            alt="Black Leather Bag"
                            class="h-full object-center object-cover md:block hidden"
                          />
                          <img
                            src="https://i.ibb.co/g9xsdCM/Rectangle-37.pngg"
                            alt="Black Leather Bag"
                            class="md:hidden w-full h-full object-center object-cover"
                          />
                        </div> -->
                        <div
                          class="md:pl-3 md:w-8/12 2xl:w-3/4 flex flex-col justify-center"
                        >
                          <!-- <p
                            class="text-xs leading-3 text-gray-800 dark:text-white md:pt-0 pt-4"
                          >
                            RF293
                          </p> -->
                          <div
                            class="flex items-center justify-between w-full pt-1"
                          >
                            <p
                              class="text-base font-black leading-none text-gray-800 dark:text-white"
                            >
                              <%=cart[x].name %>
                            </p>
                            <p
                              class="text-base font-black leading-none text-gray-800 dark:text-white"
                            >
                              <%=cart[x].quantity %>
                            </p>

                           
                          </div>
                          <!-- <p
                            class="text-xs leading-3 text-gray-600 dark:text-white pt-2"
                          >
                            Height: 10 inches
                          </p>
                          <p
                            class="text-xs leading-3 text-gray-600 dark:text-white py-4"
                          >
                            Color: Black
                          </p>
                          <p
                            class="w-96 text-xs leading-3 text-gray-600 dark:text-white"
                          >
                            Composition: 100% calf leather
                          </p> -->
                          <div class="flex items-center justify-between pt-5">
                            <div class="flex itemms-center">
                              <!-- <p
                                class="text-xs leading-3 underline text-gray-800 dark:text-white cursor-pointer"
                              >
                                Add to favorites
                              </p> -->
                              <p
                                class="text-xs leading-3 underline text-red-500 pl-5 cursor-pointer"
                              >
                                Remove
                              </p>
                            </div>
                            <p
                              class="text-base font-black leading-none text-gray-800 dark:text-white"
                            >
                              <%=Number(cart[x].unit_price) * Number(cart[x].quantity) /1000000000000000000 %> ETH
                            </p>
                          </div>
                        </div>
                      </div>
                      <% } %>
                      
                    </div>
                    <div
                      class="lg:w-96 md:w-8/12 w-full bg-gray-100 dark:bg-gray-900 h-full"
                    >
                      <div
                        class="flex flex-col lg:h-screen h-auto lg:px-8 md:px-7 px-4 lg:py-20 md:py-10 py-6 justify-between overflow-y-auto"
                      >
                        <div>
                          <p
                            class="lg:text-4xl text-3xl font-black leading-9 text-gray-800 dark:text-white"
                          >
                            Summary
                          </p>
                          <div class="flex items-center justify-between pt-16">
                            <p
                              class="text-base leading-none text-gray-800 dark:text-white"
                            >
                              Subtotal
                            </p>
                            <p
                              class="text-base leading-none text-gray-800 dark:text-white"
                            >
                            <%=total / 1000000000000000000 %> ETH
                            </p>
                          </div>
                       
                        </div>
                        <div>
                          <div
                            class="flex items-center pb-6 justify-between lg:pt-5 pt-20"
                          >
                            <p
                              class="text-2xl leading-normal text-gray-800 dark:text-white"
                            >
                              Total
                            </p>
                            <p
                              class="text-2xl font-bold leading-normal text-right text-gray-800 dark:text-white"
                            >
                            <%=total / 1000000000000000000 %> ETH
                            </p>
                          </div>
                          <button
                            id="checkoutBtn"
                            class="text-base leading-none w-full py-5 bg-gray-800 border-gray-800 border focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800 text-white dark:hover:bg-gray-700"
                          >
                            Checkout
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
         






          </div>


         
        </div>
      </div>
      
    </div>
    <%- include('partials/common_js'); %>
    <%- include('partials/common_scripts'); %>
    <script>
      $(document).ready(function () { 
        // When product needs to be added
        function checkOutHandler(e, formObj) {
          // console.log("Dhukse")
         var url = "/buyer/order/"
          $.ajax({
            type: "GET",
            url: url,
            success: function (data) {
              // Ajax call completed successfully
              if (data.code == 200) {
                // console.log(data.data);
                addOrderToChain(data.data);
              }
            },
            error: function (data) {
              // Some error in ajax call
              alert("some Error");
            },
          });
        }

        async function addOrderToChain(data) {
          console.log("inside chain function");
          console.log(data);
          if (typeof window.ethereum !== "undefined") {
            const provider = new ethers.providers.Web3Provider(window.ethereum);


            try {
              await window.ethereum.request({
                method: "eth_requestAccounts",
              });
            } catch (error) {
              console.error("Permission denied:", error);
            }
            // Create a contract instance
            const contractAddress = "<%=process.env.ECMART_CONTRACT_ADDRESS%>";
            // ABI of your contract
            var url = "/abi/get/facetAbi/<%=process.env.CHAIN_ORDER_FACET_NAME%>/";
            $.ajax({
            type: "GET",
            url: url,
            success: function (abi) {
              
                console.log(abi);
                const contractAbi = abi;
                add(contractAddress,contractAbi,provider, data);
              
            },
            error: function (data) {
              // Some error in ajax call
              alert("some Error");
            },
          });

          

            // const result1 = await contract.viewProducts(
            //   "0xdd2fd4581271e230360230f9337d5c0430bf44c0"
            // );
            // await result.wait(1);
            // console.log(result1);
          }
          else{
            console.log("Metamask is not initiated Properly !!")
          }
        }

        async function add(contractAddress, contractAbi,provider, data){
            try{
              const contract = new ethers.Contract(
              contractAddress,
              contractAbi,
              provider.getSigner()
            );
           

            const result = await contract.placeOrder(
              data.productPk,
              data.units,
              data.order_id,
              {
                value: ethers.utils.parseEther((Number(data.total) / 1000000000000000000) + ""),
              }
            );
            await result.wait(1);
            console.log(result);
            alert("order Placed !!! ");
            window.location.href = window.location.href;
            }
            catch(e){
              console.log(e);
              alert(e.reason);
            }
          }
            

     
        $("#checkoutBtn").click(function (e) {
          
          checkOutHandler(e, $(this));
        });

        
      });




    </script>

  </body>
</html>
